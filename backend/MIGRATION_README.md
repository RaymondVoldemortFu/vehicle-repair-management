# 用户认证系统修改说明

## 修改概述

本次修改移除了注册系统中的手机号/邮件认证功能，改为使用用户名+密码的简单认证方式。同时添加了应用启动时自动检查并创建数据库和表格的功能。

## 主要变更

### 1. 数据库模型变更 (`app/models/user.py`)
- ✅ 添加了 `username` 字段（必填，唯一）
- ✅ 将 `phone` 字段改为可选
- ✅ 保留 `email` 字段为可选

### 2. API Schema 变更 (`app/schemas/user.py`)
- ✅ `UserBase` 中添加 `username` 必填字段
- ✅ `UserCreate` 继承新的 `UserBase`
- ✅ `UserUpdate` 中添加可选的 `username` 字段
- ✅ `UserLogin` 改为使用 `username` 而不是 `phone`
- ✅ `UserResponse` 中添加 `username` 字段

### 3. CRUD 操作变更 (`app/crud/user.py`)
- ✅ 添加 `get_by_username()` 方法
- ✅ 修改 `create()` 方法包含 `username` 字段
- ✅ 修改 `authenticate()` 方法使用 `username` 而不是 `phone`
- ✅ 保留 `get_by_phone()` 和 `get_by_email()` 方法以备后用

### 4. API 端点变更 (`app/api/v1/users.py`)
- ✅ 注册接口：只检查用户名唯一性，移除手机号/邮箱检查
- ✅ 更新接口：只检查用户名唯一性
- ✅ 密码修改：使用用户名进行身份验证

### 5. 认证服务变更 (`app/api/v1/auth.py`, `app/service/auth_service.py`)
- ✅ 登录接口：使用用户名而不是手机号
- ✅ 错误信息：更新为"用户名或密码错误"
- ✅ 返回信息：包含用户名字段

### 6. 数据库迁移 (`app/db/init_db.py`, `run_migration.py`)
- ✅ 创建数据库初始化脚本
- ✅ 自动添加 `username` 字段
- ✅ 为现有用户生成默认用户名
- ✅ 将 `phone` 字段改为可选

### 7. 🆕 自动数据库初始化 (`app/main.py`, `app/db/init_db.py`)
- ✅ 应用启动时自动检查数据库是否存在
- ✅ 自动创建数据库（如果不存在）
- ✅ 自动创建所有表格（如果不存在）
- ✅ 自动执行数据库结构迁移
- ✅ 智能跳过已存在的数据库和表格
- ✅ 详细的启动日志和状态提示

## 使用方法

### 1. 直接启动应用（推荐）
```bash
python app/main.py
```
应用启动时会自动：
- 检查并创建数据库
- 检查并创建所有表格
- 执行必要的数据库迁移
- 显示详细的初始化状态

### 2. 手动运行数据库迁移
```bash
python run_migration.py
```

### 3. 测试数据库初始化功能
```bash
python test_db_init.py
```

### 4. 新的用户注册格式
```json
{
  "name": "张三",
  "username": "zhangsan",
  "password": "123456",
  "phone": "13800138000",  // 可选
  "email": "zhangsan@example.com",  // 可选
  "address": "北京市朝阳区"  // 可选
}
```

### 5. 新的登录格式
```json
{
  "username": "zhangsan",
  "password": "123456"
}
```

## 🚀 自动初始化功能特性

### 智能检测
- ✅ 自动检测数据库是否存在
- ✅ 自动检测表格是否存在
- ✅ 自动检测字段是否存在
- ✅ 只在需要时执行创建/迁移操作

### 安全性
- ✅ 不会覆盖现有数据
- ✅ 智能跳过已存在的结构
- ✅ 详细的操作日志记录
- ✅ 异常处理和错误恢复

### 启动日志示例
```
==============================================================
车辆维修管理系统启动中...
==============================================================
开始数据库初始化检查...
正在检查数据库状态...
数据库 'vehicle_repair' 已存在
检测到已有表存在，跳过表创建
username字段已存在，跳过添加
phone字段更新完成
数据库检查完成
✅ 数据库初始化检查完成
==============================================================
🚀 车辆维修管理系统启动完成
📖 API文档地址: http://localhost:8000/api/v1/docs
🔍 健康检查: http://localhost:8000/health
==============================================================
```

## 兼容性说明

- ✅ 现有用户数据会自动迁移，基于手机号后6位生成默认用户名
- ✅ 手机号和邮箱字段保留，可用于联系信息
- ✅ 现有的管理员和维修工人认证系统不受影响
- ✅ API 向后兼容，只是认证方式发生变化
- ✅ 支持MySQL数据库的自动创建
- ✅ 首次运行无需手动创建数据库

## 安全性提升

- ✅ 移除了手机号/邮箱验证的复杂性
- ✅ 简化了注册流程
- ✅ 用户名唯一性确保账户安全
- ✅ 保持密码加密和JWT认证机制
- ✅ 自动数据库初始化减少部署复杂性

## 注意事项

1. ✅ **无需手动创建数据库** - 应用会自动创建
2. ✅ **无需手动运行迁移** - 启动时自动执行
3. 确保数据库连接配置正确（`app/config/settings.py`）
4. 首次启动可能需要稍长时间进行数据库初始化
5. 手机号和邮箱字段仍然保留，可用于其他业务需求
6. 支持MySQL数据库，其他数据库类型会跳过自动创建功能 